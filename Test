--=====================================
-- CONFIG
--=====================================
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local GoogleScriptURL = "https://script.google.com/macros/s/AKfycbzJH8ty2nguwAGGqFtAP0kvnslsxQgTACRM5ICDY6hn9C2EYW8eMxmXYpkWj4rTMBU-Tw/exec" -- เปลี่ยนเป็นของคุณ

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "SLEEP HUB",
   Icon = 121030902371363,
   LoadingTitle = "SLEEP HUB",
   LoadingSubtitle = "by SLEEP HUB",
   ShowText = "Rayfield",
   Theme = "Dark Blue",
   ToggleUIKeybind = "K",
   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "Big Hub"
   },
   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },
   KeySystem = true,
   KeySettings = {
      Title = "SLEEP HUB",
      Subtitle = "Key System",
      Note = "กรอกคีย์ที่ได้รับ",
      FileName = "Key",
      SaveKey = true,
      GrabKeyFromSite = false,
      Key = {} -- ไม่ต้องใส่ค่า เพราะเช็คผ่าน Google Sheet
   }
})

Rayfield:LoadConfiguration()

--=====================================
-- ฟังก์ชัน HWID และตรวจสอบคีย์
--=====================================
local function GetHWID()
    local userId = Players.LocalPlayer.UserId
    local hwid = "HWID_"..userId -- สร้าง HWID เฉพาะผู้เล่น
    return hwid
end

local function CheckKey(key)
    local hwid = GetHWID()
    local url = GoogleScriptURL.."?key="..key.."&hwid="..hwid
    local success, response = pcall(function()
        return HttpService:GetAsync(url)
    end)
    
    if not success then
        return false, "ไม่สามารถเชื่อม Google Sheet"
    end
    
    local data = HttpService:JSONDecode(response)
    if data.valid then
        local expiry = tonumber(data.expiry) or 0
        if expiry > os.time() then
            return true
        else
            return false, "คีย์หมดอายุ"
        end
    else
        return false, data.reason
    end
end

local function SaveKeyExpiry(key)
    local hwid = GetHWID()
    local expiryTime = os.time() + 86400 -- 1 วัน = 86400 วินาที
    local url = GoogleScriptURL.."?key="..key.."&hwid="..hwid.."&expiry="..expiryTime
    pcall(function()
        HttpService:GetAsync(url)
    end)
end

--=====================================
-- Key System Callback
--=====================================
Rayfield:CreateKeySystem({
    Callback = function(Key)
        local valid, reason = CheckKey(Key)
        if valid then
            print("คีย์ถูกต้อง! เริ่มใช้งาน Hub")
            -- บันทึกวันหมดอายุ หากยังไม่มี
            SaveKeyExpiry(Key)
        else
            Players.LocalPlayer:Kick("คีย์ไม่ถูกต้อง หรือหมดอายุ: "..tostring(reason))
        end
    end
})

--=====================================
-- ตรวจสอบเกมก่อนโหลด Script
--=====================================
local Kayak = game.PlaceId == 136404558442020
local Surf = game.PlaceId == 136404558442020 -- ปรับ PlaceId จริงของ Surf

repeat wait() until game:IsLoaded()

if Kayak and Surf then
    loadstring(game:HttpGet("https://raw.githubusercontent.com/sleephub-pro/SLRRP-HUB/refs/heads/main/Kayak%20and%20Surf"))()
    print("Loaded: Kayak and Surf Script")
else
    Players.LocalPlayer:Kick("ไม่รองรับเกมนี้")
    wait(3)
    game:Shutdown()
    wait(3)
    while true do end
end
