-- CONFIG: ใส่ URL และ TOKEN ที่ได้จาก Apps Script
local GoogleScriptURL = "https://script.google.com/macros/s/AKfycbzJH8ty2nguwAGGqFtAP0kvnslsxQgTACRM5ICDY6hn9C2EYW8eMxmXYpkWj4rTMBU-Tw/exec" -- เปลี่ยนเป็นของคุณ
local GoogleToken = "FNE9D2K9-SSLA-88DK-PPWQ-99102" -- ต้องตรงกับ SECRET_TOKEN ใน Apps Script

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- สำหรับ Rayfield UI (สมมติว่าคุณมี Rayfield ตามที่ส่งมา)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "SLEEP HUB",
   LoadingTitle = "SLEEP HUB",
   LoadingSubtitle = "by SLEEP HUB",
   ShowText = "Rayfield",
   Theme = "Dark Blue",
   ToggleUIKeybind = "K",
   ConfigurationSaving = { Enabled = true, FolderName = nil, FileName = "Big Hub" },
   Discord = { Enabled = false }
})
-- Tab และ Input (API ของ Rayfield อาจต่างกันเล็กน้อยในเวอร์ชันคุณ ถ้าไม่ตรงให้แทนที่ด้วยวิธีสร้าง UI ของ Rayfield ที่ใช้ได้)
local MainTab = Window:CreateTab("Auth")

-- ---------- HWID helper ----------
-- พยายามใช้ writefile/readfile เพื่อเก็บ HWID แบบถาวร (ต้องรันบน executor ที่ให้สิทธิ์)
local HWID_FILENAME = "sleephub_hwid.txt"

local function fileExists(name)
  if isfile then
    return isfile(name)
  end
  return false
end

local function saveHWIDToFile(hwid)
  if writefile then
    pcall(function() writefile(HWID_FILENAME, hwid) end)
  end
end

local function readHWIDFromFile()
  if isfile then
    local ok, content = pcall(function() return readfile(HWID_FILENAME) end)
    if ok and content then return content end
  end
  return nil
end

-- ฟังก์ชันสร้าง HWID ถาวร (ถ้าไม่มีไฟล์จะสร้าง GUID ใหม่และพยายามบันทึก)
local function getHWID()
  -- พยายามอ่านจากไฟล์ก่อน
  local hw = readHWIDFromFile()
  if hw and hw ~= "" then
    return hw
  end

  -- ถ้าไม่มีไฟล์, สร้างจากข้อมูลที่เป็นไปได้: UserId + GUID
  local seed = tostring(LocalPlayer.UserId) .. "-" .. HttpService:GenerateGUID(false)
  -- แฮชง่ายๆ เพื่อให้สั้นลง (ใช้ JSONEncode แล้ว CRC แบบง่าย)
  local hwid = HttpService:GenerateGUID(false) -- พอใช้งาน (ไม่สามารถได้ HW จริงของเครื่องบน Roblox)
  -- พยายามเขียนไฟล์
  saveHWIDToFile(hwid)
  return hwid
end

-- ---------- HTTP helper ----------
local function postToServer(payload)
  local body = HttpService:JSONEncode(payload)
  local headers = { ["Content-Type"] = "application/json" }
  local ok, res = pcall(function()
    return HttpService:PostAsync(GoogleScriptURL, body, Enum.HttpContentType.ApplicationJson)
  end)
  if not ok then
    return false, "HTTP request failed: " .. tostring(res)
  end
  local decoded = nil
  local succ, dec = pcall(function() return HttpService:JSONDecode(res) end)
  if not succ then
    return false, "Failed to decode response"
  end
  return true, dec
end

-- ---------- Key flow ----------
local function redeemKeyFlow(keyString)
  local hwid = getHWID()
  local payload = {
    token = GoogleToken,
    action = "redeem",
    key = tostring(keyString),
    hwid = tostring(hwid),
    usedBy = tostring(LocalPlayer.Name)
  }

  local ok, res = postToServer(payload)
  if not ok then
    return false, res
  end

  if res.success then
    -- ตัวอย่าง: เก็บสถานะ (คุณอาจบันทึกลงตัวแปร global หรือ file เพิ่มเติม)
    return true, res
  else
    return false, res.message or "Unknown error"
  end
end

-- ---------- UI: ปุ่มใส่คีย์ (Rayfield) ----------
-- ผมใช้ CreateInput + CreateButton ซึ่งมีอยู่ใน Rayfield forks หลายตัว
-- หากเวอร์ชันคุณต่าง ให้ใช้วิธีรับ input ที่ Rayfield ของคุณรองรับ
local inputBox = MainTab:CreateInput({
  Name = "ใส่คีย์ (Key)",
  PlaceholderText = "วางคีย์ที่นี่แล้วกด Submit",
  RemoveTextAfterFocusLost = false,
  Callback = function(text) end
})

local submitBtn = MainTab:CreateButton({
  Name = "ยืนยันคีย์",
  Callback = function()
    local key = inputBox.Configuration.Value or inputBox.Value or inputBox.Text or inputBox -- try fields
    if not key or key == "" then
      Rayfield:Notify({Title="SLEEP HUB", Content="กรุณากรอกคีย์", Duration=3})
      return
    end
    Rayfield:Notify({Title="SLEEP HUB", Content="กำลังตรวจสอบคีย์...", Duration=2})
    local ok, res = redeemKeyFlow(key)
    if ok then
      -- ตัวอย่าง: แสดงผล และ โหลดสคริปต์เกมส์ (เช่นที่คุณต้องการ)
      Rayfield:Notify({Title="SLEEP HUB", Content="ยืนยันคีย์สำเร็จ! โหลดสคริปต์...", Duration=4})
      -- ถ้าต้องการอ่านเวลาที่เหลือ: res.expireTsMs หรือ res.remainingMs
      print("Key response:", game:GetService("HttpService"):JSONEncode(res))
      -- ตัวอย่าง: โหลดสคริปต์จริงของเกมเมื่อสำเร็จ
      -- (ใส่โค้ดโหลดสคริปต์ของคุณในนี้ เช่น loadstring(HttpGet(...)) )
      -- ตัวอย่างจากเดิมในสคริปต์ของคุณ:
      -- if Kayak and Surf then loadstring(game:HttpGet("..."))() end
    else
      Rayfield:Notify({Title="SLEEP HUB", Content="คีย์ไม่ถูกต้อง/หมดอายุ/ถูกผูกแล้ว: "..tostring(res), Duration=5})
    end
  end
})
