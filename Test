-- ที่ส่วน KeySystem ของ WindUI:
local HttpService = game:GetService("HttpService")
local API_URL = "https://your-server.example.com/validate" -- เปลี่ยนเป็น URL จริง
local WRITEFILE_NAME = "ftgshub_key.txt" -- ใช้กับ exploit ที่มี writefile/readfile

local function trySaveKeyLocal(key)
    pcall(function()
        if writefile then
            writefile(WRITEFILE_NAME, key)
        end
    end)
end

local function tryReadLocalKey()
    local ok, content = pcall(function()
        if isfile and isfile(WRITEFILE_NAME) then
            return readfile(WRITEFILE_NAME)
        end
        return nil
    end)
    if ok then return content end
    return nil
end

-- พยายามตรวจหา HWID ของ executor (ตัวอย่าง: syn)
local function getHWID()
    local ok, hw = pcall(function()
        if syn and syn.get_guid then
            return syn.get_guid()
        elseif identifyexecutor then
            return identifyexecutor()
        end
        -- ไม่มีก็ส่ง placeholder (แนะนำให้ดัดแปลงตาม executor)
        return "unknown_hwid"
    end)
    if ok then return hw end
    return "unknown_hwid"
end

local function validateKeyRemote(key)
    local hw = getHWID()
    local url = API_URL .. "?key=" .. HttpService:UrlEncode(key) .. "&hwid=" .. HttpService:UrlEncode(hw)
    local ok, resp = pcall(function()
        return HttpService:GetAsync(url)
    end)
    if not ok then
        return false, "ไม่สามารถติดต่อ server"
    end
    local parsed = nil
    local success, err = pcall(function() parsed = HttpService:JSONDecode(resp) end)
    if not success then
        return false, "response จาก server ไม่ถูกต้อง"
    end
    if parsed.success and parsed.valid then
        -- บันทึกคีย์ไว้เครื่อง (เพื่อไม่ต้องใส่ใหม่)
        trySaveKeyLocal(key)
        return true, "Key valid"
    else
        return false, parsed.message or "invalid"
    end
end

-- ตัวอย่าง KeyValidator สำหรับ WindUI
KeyValidator = function(EnteredKey)
    -- ถ้ามีค่าเก็บในเครื่อง ให้เช็กก่อน
    local localKey = tryReadLocalKey()
    if localKey and localKey == EnteredKey then
        -- อาจยังอยากเช็ก remote ว่าไม่หมดอายุ -> แต่เพื่อประสิทธิภาพ เราตรวจ remote คร่าวๆ
        local ok, msg = validateKeyRemote(EnteredKey)
        if ok then return true end
        -- หาก remote บอกหมดอายุให้ return false
        return false
    end

    -- ถ้าหากยังไม่มี ให้เรียก validate remote
    local ok, msg = validateKeyRemote(EnteredKey)
    if ok then
        -- ผ่าน -> เก็บ
        return true
    else
        -- ไม่ผ่าน
        return false
    end
end
